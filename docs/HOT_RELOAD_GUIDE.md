# ç¯å¢ƒå˜é‡çƒ­é‡è½½åŠŸèƒ½è¯´æ˜

## âœ¨ æ ¸å¿ƒç‰¹æ€§

**æ— éœ€é‡å¯ï¼Œé…ç½®å³ç”Ÿæ•ˆï¼**

- âœ… ä¿å­˜é…ç½®åè‡ªåŠ¨çƒ­é‡è½½
- âœ… åç«¯æœåŠ¡è‡ªåŠ¨æ›´æ–°é…ç½®
- âœ… å‰ç«¯é¡µé¢è‡ªåŠ¨åˆ·æ–°
- âœ… Supabase å®¢æˆ·ç«¯è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–
- âœ… æ•´ä¸ªè¿‡ç¨‹ä»…éœ€ 1-2 ç§’

## ğŸ¯ å·¥ä½œåŸç†

### 1. é…ç½®ä¿å­˜
å½“ç”¨æˆ·ç‚¹å‡»"ä¿å­˜é…ç½®"åï¼š
```
ç”¨æˆ·æäº¤ â†’ ä¿å­˜åˆ° .env æ–‡ä»¶ â†’ è§¦å‘çƒ­é‡è½½
```

### 2. åç«¯çƒ­é‡è½½
```javascript
// æ­¥éª¤1: é‡æ–°è¯»å– .env æ–‡ä»¶
envReloader.reload('.env')
  â†“
// æ­¥éª¤2: æ›´æ–° process.env
Object.assign(process.env, newEnvVars)
  â†“
// æ­¥éª¤3: é‡æ–°åˆå§‹åŒ–æœåŠ¡
resetSupabaseClient()
  â†“
// å®Œæˆï¼æ–°é…ç½®å·²ç”Ÿæ•ˆ
```

### 3. å‰ç«¯åˆ·æ–°
```javascript
// ä¿å­˜æˆåŠŸåè‡ªåŠ¨åˆ·æ–°é¡µé¢
window.location.reload()
  â†“
// Vite ä¼šé‡æ–°æ³¨å…¥ç¯å¢ƒå˜é‡
// åº”ç”¨ä½¿ç”¨æ–°é…ç½®å¯åŠ¨
```

## ğŸ”§ æŠ€æœ¯å®ç°

### åç«¯çƒ­é‡è½½

#### envReloader.js
```javascript
class EnvReloader {
  reload(envPath) {
    // è¯»å– .env æ–‡ä»¶
    const envConfig = dotenv.parse(fs.readFileSync(envPath));
    
    // æ›´æ–° process.env
    for (const [key, value] of Object.entries(envConfig)) {
      process.env[key] = value;
    }
    
    return { success: true };
  }
}
```

#### env.js - ä½¿ç”¨ Getter
```javascript
// âŒ æ—§æ–¹å¼ï¼šé™æ€å€¼
export const env = {
  supabaseUrl: process.env.SUPABASE_URL
};

// âœ… æ–°æ–¹å¼ï¼šåŠ¨æ€ Getter
export const env = {
  get supabaseUrl() {
    return process.env.SUPABASE_URL;
  }
};
```

ä½¿ç”¨ Getter çš„å¥½å¤„ï¼š
- æ¯æ¬¡è®¿é—®éƒ½è¯»å–æœ€æ–°çš„ `process.env`
- ç¯å¢ƒå˜é‡æ›´æ–°åç«‹å³ç”Ÿæ•ˆ
- æ— éœ€é‡å¯è¿›ç¨‹

#### supabaseClient.js - æ”¯æŒé‡ç½®
```javascript
let supabase = null;

function initializeSupabase() {
  supabase = createClient(env.supabaseUrl, env.supabaseAnonKey);
}

export function resetSupabaseClient() {
  supabase = null;
  initializeSupabase(); // ä½¿ç”¨æ–°çš„ç¯å¢ƒå˜é‡
}
```

### å‰ç«¯è‡ªåŠ¨åˆ·æ–°

```javascript
const result = await fetch('/api/env/upload', {
  method: 'POST',
  body: JSON.stringify({ frontendEnv, backendEnv })
});

if (result.success && result.reloaded) {
  // åç«¯å·²çƒ­é‡è½½ï¼Œå‰ç«¯åˆ·æ–°é¡µé¢
  window.location.reload();
}
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼ ç»Ÿæ–¹å¼ï¼ˆéœ€è¦é‡å¯ï¼‰
```
ä¿å­˜é…ç½® â†’ åœæ­¢åç«¯ (Ctrl+C) â†’ å¯åŠ¨åç«¯ (npm start) â†’ åˆ·æ–°å‰ç«¯
â±ï¸ æ€»è€—æ—¶ï¼š15-30ç§’
```

### çƒ­é‡è½½æ–¹å¼ï¼ˆæœ¬å®ç°ï¼‰
```
ä¿å­˜é…ç½® â†’ è‡ªåŠ¨çƒ­é‡è½½ â†’ è‡ªåŠ¨åˆ·æ–°
â±ï¸ æ€»è€—æ—¶ï¼š1-2ç§’
```

**é€Ÿåº¦æå‡ï¼š10-30å€ï¼** ğŸš€

## ğŸ¬ ç”¨æˆ·ä½“éªŒæµç¨‹

### å®Œæ•´æ¼”ç¤º

1. **è®¿é—®é…ç½®é¡µé¢**
   ```
   http://localhost:5173
   â†“
   è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒå˜é‡ç¼ºå¤±
   â†“
   æ˜¾ç¤ºé…ç½®å‘å¯¼
   ```

2. **å¡«å†™é…ç½®**
   ```
   ç²˜è´´æˆ–ä¸Šä¼  .env å†…å®¹
   â†“
   å®æ—¶è§£æå’ŒéªŒè¯
   â†“
   æ˜¾ç¤ºå‰ç«¯/åç«¯é…ç½®çŠ¶æ€
   ```

3. **ä¿å­˜é…ç½®**
   ```
   ç‚¹å‡»"ä¿å­˜é…ç½®ï¼ˆæ— éœ€é‡å¯ï¼‰"
   â†“
   æ˜¾ç¤ºåŠ è½½åŠ¨ç”» (1ç§’)
   â†“
   åç«¯çƒ­é‡è½½å®Œæˆ
   â†“
   é¡µé¢è‡ªåŠ¨åˆ·æ–° (1ç§’)
   â†“
   âœ… åº”ç”¨æ­£å¸¸è¿è¡Œï¼
   ```

### ç”¨æˆ·çœ‹åˆ°çš„æç¤º

```
ä¿å­˜ä¸­... â³
  â†“
âœ… é…ç½®å·²ä¿å­˜å¹¶ç«‹å³ç”Ÿæ•ˆï¼
åç«¯å·²è‡ªåŠ¨åŠ è½½æ–°é…ç½®ï¼Œå‰ç«¯å°†è‡ªåŠ¨åˆ·æ–°ã€‚
  â†“
[é¡µé¢è‡ªåŠ¨åˆ·æ–°]
  â†“
åº”ç”¨æ­£å¸¸è¿è¡Œ ğŸ‰
```

## ğŸ” æ”¯æŒçš„çƒ­é‡è½½å†…å®¹

### âœ… å¯ä»¥çƒ­é‡è½½çš„é…ç½®

- **Supabase é…ç½®**
  - `SUPABASE_URL`
  - `SUPABASE_ANON_KEY`
  - `SUPABASE_SERVICE_ROLE_KEY`

- **LLM API é…ç½®**
  - `LLM_API_URL`
  - `LLM_API_KEY`
  - `LLM_MODEL`

- **è®¯é£è¯­éŸ³é…ç½®**
  - `IFLYTEK_APP_ID`
  - `IFLYTEK_API_KEY`
  - `IFLYTEK_API_SECRET`

- **é«˜å¾·åœ°å›¾é…ç½®**
  - `AMAP_WEB_SERVICE_KEY`
  - `VITE_AMAP_JS_KEY`
  - `VITE_AMAP_JS_SECURITY_CODE`

- **å…¶ä»–é…ç½®**
  - `FRONTEND_ORIGIN`
  - `STORAGE_BUCKET`
  - `TMP_DIR`

### âš ï¸ ä¸å¯çƒ­é‡è½½çš„é…ç½®

è¿™äº›é…ç½®éœ€è¦é‡å¯æœåŠ¡å™¨æ‰èƒ½ç”Ÿæ•ˆï¼š

- `PORT` - ç«¯å£ä¿®æ”¹éœ€è¦é‡å¯
- `NODE_ENV` - ç¯å¢ƒæ¨¡å¼éœ€è¦é‡å¯

å¦‚æœä¿®æ”¹äº†è¿™äº›é…ç½®ï¼Œç³»ç»Ÿä¼šæç¤ºéœ€è¦é‡å¯ã€‚

## ğŸ› ï¸ å¼€å‘è€…æŒ‡å—

### æ·»åŠ æ–°çš„å¯çƒ­é‡è½½æœåŠ¡

å¦‚æœä½ çš„æœåŠ¡ä¾èµ–ç¯å¢ƒå˜é‡ï¼ŒæŒ‰ä»¥ä¸‹æ­¥éª¤å®ç°çƒ­é‡è½½ï¼š

#### 1. åœ¨æœåŠ¡æ¨¡å—ä¸­æ·»åŠ é‡ç½®å‡½æ•°

```javascript
// services/yourService.js
let serviceClient = null;

function initializeService() {
  serviceClient = createClient(env.yourApiKey);
}

// åˆå§‹åŒ–
initializeService();

// å¯¼å‡ºé‡ç½®å‡½æ•°
export function resetYourService() {
  serviceClient = null;
  initializeService();
}

export { serviceClient };
```

#### 2. åœ¨ envController.js ä¸­è°ƒç”¨é‡ç½®

```javascript
import { resetYourService } from '../services/yourService.js';

// åœ¨çƒ­é‡è½½åè°ƒç”¨
if (reloadResult.success) {
  resetSupabaseClient();
  resetYourService(); // æ·»åŠ è¿™è¡Œ
}
```

#### 3. ç¡®ä¿ä½¿ç”¨ Getter è®¿é—®ç¯å¢ƒå˜é‡

```javascript
// âŒ é”™è¯¯
const apiKey = process.env.YOUR_API_KEY;

// âœ… æ­£ç¡®
const apiKey = env.yourApiKey; // env ä½¿ç”¨ getter
```

## ğŸ“ é…ç½®éªŒè¯

ç³»ç»Ÿä¼šè‡ªåŠ¨éªŒè¯é…ç½®ï¼š

```javascript
// å‰ç«¯éªŒè¯
- URL æ ¼å¼æ£€æŸ¥
- å¯†é’¥é•¿åº¦æ£€æŸ¥
- å¿…å¡«é¡¹æ£€æŸ¥

// åç«¯éªŒè¯
- é…ç½®å®Œæ•´æ€§æ£€æŸ¥
- æ ¼å¼éªŒè¯
- æœåŠ¡è¿æ¥æµ‹è¯•
```

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜ï¼šé…ç½®ä¿å­˜åæ²¡æœ‰ç”Ÿæ•ˆ

**æ£€æŸ¥æ­¥éª¤ï¼š**

1. æŸ¥çœ‹åç«¯æ—¥å¿—
   ```bash
   # åº”è¯¥çœ‹åˆ°ï¼š
   âœ… ç¯å¢ƒå˜é‡å·²çƒ­é‡è½½
   âœ… Supabase å®¢æˆ·ç«¯å·²é‡æ–°åˆå§‹åŒ–
   ğŸ‰ çƒ­é‡è½½å®Œæˆï¼Œé…ç½®å·²ç”Ÿæ•ˆï¼
   ```

2. ç¡®è®¤é¡µé¢å·²åˆ·æ–°
   - æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·
   - æŸ¥çœ‹ Network æ ‡ç­¾
   - ç¡®è®¤é¡µé¢æœ‰é‡æ–°åŠ è½½

3. æ£€æŸ¥ .env æ–‡ä»¶
   ```bash
   # ç¡®è®¤æ–‡ä»¶å·²æ›´æ–°
   cat backend/.env
   cat frontend/.env
   ```

### é—®é¢˜ï¼šçƒ­é‡è½½å¾ˆæ…¢

**åŸå› åˆ†æï¼š**

çƒ­é‡è½½æœ¬èº«å¾ˆå¿«ï¼ˆ<100msï¼‰ï¼Œæ…¢çš„æ˜¯é¡µé¢åˆ·æ–°ï¼š

```
çƒ­é‡è½½: 50-100ms
é¡µé¢åˆ·æ–°: 1-2ç§’ï¼ˆæ­£å¸¸ï¼‰
```

**ä¼˜åŒ–å»ºè®®ï¼š**

- ä½¿ç”¨å¿«é€Ÿçš„ç½‘ç»œè¿æ¥
- å‡å°‘æµè§ˆå™¨æ‰©å±•
- ä½¿ç”¨å¼€å‘è€…æ¨¡å¼ï¼ˆç¦ç”¨ç¼“å­˜ï¼‰

### é—®é¢˜ï¼šæŸäº›é…ç½®æ²¡æœ‰ç”Ÿæ•ˆ

**å¯èƒ½åŸå› ï¼š**

1. è¯¥é…ç½®ä¸æ”¯æŒçƒ­é‡è½½ï¼ˆå¦‚ PORTï¼‰
2. æœåŠ¡æ²¡æœ‰é‡æ–°åˆå§‹åŒ–
3. ä½¿ç”¨äº†é™æ€å€¼è€Œä¸æ˜¯ Getter

**è§£å†³æ–¹æ¡ˆï¼š**

```javascript
// æ£€æŸ¥æ˜¯å¦ä½¿ç”¨ Getter
console.log(env.supabaseUrl); // åº”è¯¥æ˜¾ç¤ºæ–°å€¼

// æ‰‹åŠ¨é‡ç½®æœåŠ¡
resetSupabaseClient();
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

ç³»ç»Ÿä¼šè®°å½•è¯¦ç»†çš„çƒ­é‡è½½æ—¥å¿—ï¼š

```bash
[2025-10-30 14:00:00] INFO: ğŸ“ é…ç½®æ–‡ä»¶å·²ä¿å­˜ï¼Œå¼€å§‹çƒ­é‡è½½...
[2025-10-30 14:00:00] INFO: âœ… ç¯å¢ƒå˜é‡å·²çƒ­é‡è½½ { added: 2, updated: 3 }
[2025-10-30 14:00:00] INFO: ğŸ”„ é‡ç½® Supabase å®¢æˆ·ç«¯...
[2025-10-30 14:00:00] INFO: Supabase client initialised (anon key)
[2025-10-30 14:00:00] INFO: Supabase service client initialised
[2025-10-30 14:00:00] INFO: âœ… Supabase å®¢æˆ·ç«¯å·²é‡æ–°åˆå§‹åŒ–
[2025-10-30 14:00:00] INFO: ğŸ‰ çƒ­é‡è½½å®Œæˆï¼Œé…ç½®å·²ç”Ÿæ•ˆï¼
```

## ğŸ‰ æ€»ç»“

### ä¼˜åŠ¿

1. **å¿«é€Ÿ** - 1-2ç§’å®Œæˆé…ç½®æ›´æ–°
2. **ç®€å•** - ä¸€é”®ä¿å­˜ï¼Œè‡ªåŠ¨ç”Ÿæ•ˆ
3. **å®‰å…¨** - éªŒè¯é…ç½®ï¼Œé˜²æ­¢é”™è¯¯
4. **æ™ºèƒ½** - è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–æœåŠ¡
5. **å‹å¥½** - æ¸…æ™°çš„æç¤ºå’Œè¿›åº¦

### å¯¹æ¯”è¡¨

| ç‰¹æ€§ | ä¼ ç»Ÿæ–¹å¼ | çƒ­é‡è½½æ–¹å¼ |
|------|---------|-----------|
| è€—æ—¶ | 15-30ç§’ | 1-2ç§’ |
| æ“ä½œæ­¥éª¤ | 5æ­¥ | 1æ­¥ |
| ç”¨æˆ·ä½“éªŒ | å¤æ‚ | ç®€å• |
| å‡ºé”™é£é™© | é«˜ | ä½ |
| å¼€å‘æ•ˆç‡ | ä½ | é«˜ |

çƒ­é‡è½½æŠ€æœ¯è®©ç¯å¢ƒé…ç½®å˜å¾—**å¿«é€Ÿã€ç®€å•ã€å¯é **ï¼ğŸš€
